package main

import (
	"context"
	"fmt"

	"github.com/aws/aws-sdk-go-v2/config"
	"github.com/aws/aws-sdk-go-v2/service/ec2"
	"github.com/aws/aws-sdk-go-v2/service/route53"
	"github.com/aws/aws-sdk-go-v2/service/route53/types"
)

func checkError(message string, err error) {
	if err != nil {
		fmt.Printf("%v\n%v", message, err)
	}
}

type data struct {
	Name       string   `json:"name"`
	Ttl        int64    `json:"ttl"`
	InstanceId []string `json:"instanceId"`
	ZoneId     string   `json:"zoneId"`
	Action     string   `json:"action"`
}

func (val *data) updateDns(ctx context.Context) {

	cfg, err := config.LoadDefaultConfig(ctx, config.WithSharedConfigProfile("pranshu"))
	checkError("Could not load the configuration.", err)

	ec2_client := ec2.NewFromConfig(cfg)
	input := &ec2.DescribeInstancesInput{InstanceIds: val.InstanceId}

	result, _ := ec2_client.DescribeInstances(context.Background(), input)

	var ip []string
	for _, reservation := range result.Reservations {
		for _, instance := range reservation.Instances {
			ip = append(ip, *instance.PublicIpAddress)
		}
	}

	client := route53.NewFromConfig(cfg)

	output, err := client.ChangeResourceRecordSets(ctx, &route53.ChangeResourceRecordSetsInput{
		HostedZoneId: &val.ZoneId,
		ChangeBatch: &types.ChangeBatch{
			Changes: []types.Change{{
				Action: types.ChangeAction(val.Action),
				ResourceRecordSet: &types.ResourceRecordSet{
					Name: &val.Name,
					Type: types.RRTypeA,
					TTL:  &val.Ttl,
					ResourceRecords: []types.ResourceRecord{
						{Value: &ip[0]},
					},
				},
			}},
		},
	})
	checkError("Could not update the record.", err)

	fmt.Printf("Change status: %v\n", output.ChangeInfo.Status.Values())
}

func main() {

	values := data{
		Name:       "paulpranshu.xyz",
		Ttl:        3600,
		ZoneId:     "Z014611832PD0HCGBA9SF",
		Action:     "UPSERT",
		InstanceId: []string{"i-0950af33fbca63954"},
	}

	values.updateDns(context.Background())
}
